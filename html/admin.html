<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>TapIn.tv</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="FS Stack">

    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/themes/base/jquery-ui.css" type="text/css" media="all" /> 
    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="shortcut icon" href="assets/ico/favicon.ico">
    <meta property="og:image" content="assets/ico/social.jpg"/>
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png">

    <style type="text/css">
        #wrap {
            width: 1500px;
            height: 100%;
            margin: 0 auto;
        }

        #nav {
            width: 200px;
            height: 100%;
            float: left;
        }

        #nav li {
            list-style: none;
        }

        #nav li a {
            display: block;
            width: 100%;
            padding: 15px 0;
            text-align: center;
            background-color: #ccc;
            color: black;
            text-decoration: none;
            font-size: 1.2em;
        }

        #nav li a.active {
            background-color: red;
            color: white;
        }

        #content {
            width: 1200px;
            height: 100%;
            float: right;
        }

        .badgepickerwidget span.ui-buttonset {
            height: 800px;
            overflow-x: hidden;
            overflow-y: auto;
            text-align: center;
        }

        .badgepickerwidget a.btn-success {
            width: 100%;
            display: block;
        }

        .badgepickerwidget {
            font-size: .6em;
        }

        .badgepickerwidget img {
            width: 50px;
            height: 50px;
        }

        .siteview {
            width: 100%;
            height: 500px;
        }

        .streamtools {
            float: left;
            width: 50%;
        }
        .streamdetails {
            float: left;
            width: 50%;
        }
    </style>
  </head>

  <body>
    <div id="wrap">
        <ul id="nav">
            <li><a id="grantbadges" href="#">Grant Badge</a></li>
            <li><a id="removestreams" href="#">Remove Streams</a></li>
        </ul>
        <div id="content">

        </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.21/jquery-ui.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        var token = localStorage.admintoken;
        if (typeof(token) === 'undefined') {
            token = prompt('What is your token?');
            localStorage.admintoken = token;
        }
        var badgePickerWidget = function(element, onSuccess)
        {
            var id = '';
            this.selectBadges = function(badgesToSelect)
            {
                for (var i in badgesToSelect) {
                    element.find('#' + id + 'badge-' + badgesToSelect[i]).prop('checked', true);
                    element.find('label[for="' + id + 'badge-' + badgesToSelect[i] + '"]').attr('aria-pressed', 'true').addClass('ui-state-active');
                }
            }

            this.disableBadges = function(badgesToDisable)
            {
                for (var i in badgesToDisable) {
                    element.find('#' + id + 'badge-' + badgesToDisable[i]).remove();
                    element.find('label[for="' + id + 'badge-' + badgesToDisable[i] + '"]').remove();
                }
            }

            var buttonSet;
            this.constructor = function()
            {
                element = $(element);

                buttonSet = $('<span></span>');
                element.html('');
                element.addClass('badgepickerwidget');

                id = element.attr('id');

                for (var i in window.badges) {
                    var badge = window.badges[i];
                    var badgeDisplayWidget = '<img src="assets/img/badges/b-' + badge['id'] + '.png" /><br />' + badge['name'];
                    var badgePickerHtml = '<input type="checkbox" data-id="' + badge['id'] + '" id="' + id + 'badge-' + badge['id'] + '" /><label title="' + badge['description'] + '" for="' + id + 'badge-' + badge['id'] + '">' + badgeDisplayWidget + '</label>';

                    buttonSet.append(badgePickerHtml);
                }
                buttonSet.buttonset();
                element.append(buttonSet);

                var doneButton = $('<a href="#" class="btn btn-success">Done</a>');
                doneButton.click(function(event){
                    event.stopPropagation();
                    var selected = [];
                    element.find('input:checked').each(function(){
                        selected.push(parseInt($(this).attr('data-id')));
                    });
                    onSuccess(selected);
                    return false;
                });

                element.append(doneButton);
            }
            this.constructor();
        }

        var getApi = function(hat, lambda)
        {
            $.get('http://api.tapin.tv/web/' + hat, lambda, 'json');
        }

        var siteDebuggerPage = function(element)
        {
            this.hasPrompted = false;
            this.constructor = function()
            {
                element = $(element);
                element.html('');

                var streamidtitle = $('<h1>Waiting for page load...</h1>');

                element.append(streamidtitle);

                var frame = $('<iframe class="siteview" src="/index.html"></iframe>');
                element.append(frame);
                var crosstalk = frame[0].contentWindow;

                var detailPane = $('<div class="streamdetails"></div>');
                detailPane.append('<h2>Diags</h2>');
                var details = $('<table></table>');
                detailPane.append(details);

                element.append(detailPane);

                setTimeout(function(){
                    console.log('onchange');
                    crosstalk.fe.onStreamChange.register(function(id,obj){
                        streamidtitle.html('Watching <a href="http://api.tapin.tv/web/get/stream/' + id + '" target="_blank">' + id + '</a>');
                        details.html('<thead><tr><td>KEY</td><td>VAL</td></tr></thead>');
                        for (var key in obj) {
                            details.append('<tr><td>' + key + '</td><td><a href="http://api.tapin.tv/web/get/streamby' + key + '/' + obj[key] + '" target="_blank">' + obj[key] + '</a>' + '</td></tr>');
                        }
                    });
                }, 5000);

                var toolPane = $('<div class="streamtools"></div>');
                element.append(toolPane);

                var removeCurrentStreamButton = $('<a href="#" class="btn btn-danger" style="width: 100%">Remove Current Stream</a>');
                removeCurrentStreamButton.click(function(event){
                    event.stopPropagation();
                    if (!this.hasPrompted) {
                        this.hasPrompted = confirm("DANGER DANGER: there is no undo! Sure? (You won't get this warning again!)");
                    }
                    if (this.hasPrompted) {
                        var current_stream = crosstalk.fe.sidebar.player.getPlayer().getClip().streamId;
                        getApi('fuck/' + current_stream + '?token=' + token);
                    }
                    return false;
                });

                toolPane.append(removeCurrentStreamButton);
            }
            this.constructor();
        }

        var badgePage = function(element)
        {
            var _this = this;

            this.constructor = function(){
                element = $(element);
                element.html('');
                var usernameField = $('<form class="selectuser"><input type="text" placeholder="Username" /><input type="submit" value="Go" class="btn btn-success" /></form>');
                var instructionArea = $('<div></div>');
                var badgePickerArea = $('<div></div>');
                element.append(usernameField);
                element.append(instructionArea);
                element.append(badgePickerArea);
                usernameField.submit(function(event){
                    event.stopPropagation();
                    var username = usernameField.find('input[type="text"]').val();

                    var previouslySelectedBadges = [];
                    var badgePicker = new badgePickerWidget(badgePickerArea, function(selected){
                        // Calculate deltas
                        var toAdd = [];
                        var toRemove = [];
                        for (var i in selected)
                        {
                            if ($.inArray("" + selected[i], previouslySelectedBadges) < 0) {
                                toAdd.push(selected[i]);
                            }
                        }
                        for (var i in previouslySelectedBadges)
                        {
                            if ($.inArray(parseInt(previouslySelectedBadges[i]), selected) < 0) {
                                toRemove.push(parseInt(previouslySelectedBadges[i]));
                            }
                        }

                        // Remove the badges
                        for (var i in toAdd)
                        {
                            getApi('givebadge?username=' + username + '&badge=' + toAdd[i]);
                        }
                        for (var i in toRemove)
                        {
                            getApi('removebadge?username=' + username + '&badge=' + toRemove[i]);
                        }

                        // Allow sending an email
                        if (toAdd.length > 0 && confirm('Would you like to send an email?')) {
                            var content = '<p>The user will be informed that they got the following badges: <ul>';
                            for (var i in toAdd) {
                                content += '<li>' + window.badges[toAdd[i] - 1].name + '</li>';
                            }
                            content += '</ul></p>';
                            content += '<p>Choose what badges to promote to the user:</p>';
                            instructionArea.html(content);
                            badgePickerArea.html('');
                            var promoterArea = new badgePickerWidget(badgePickerArea, function(selected){
                                getApi('/badgenotifyemail?username=' + username + '&badges=' + toAdd.join(',') + '&promote=' + selected.join(','));
                                _this.constructor();
                            });
                            promoterArea.disableBadges(previouslySelectedBadges);
                            promoterArea.disableBadges(toAdd);
                        } else {
                            _this.constructor();
                        }
                    });
                    getApi('get/user/' + username, function(data){
                        badgePicker.selectBadges(data.badge);
                        previouslySelectedBadges = data.badge;
                    });
                    return false;
                });
            }
            this.constructor();
        }

        window.populateBadges = function(badges)
        {
            window.badges = badges;
        }

        var setCurrent = function(elem)
        {
            $('#nav a').removeClass('active');
            $('#nav #' + elem).addClass('active');
        }

        $(document).ready(function(){
            $("#grantbadges").click(function(){
                event.stopPropagation();
                setCurrent('grantbadges');
                var badgePageView = new badgePage('#content');
                return false;
            });
            $("#removestreams").click(function(){
                event.stopPropagation();
                setCurrent('removestreams');
                var siteDebuggerPageView = new siteDebuggerPage('#content');
                return false;
            });
        })
    </script>
    <script src="https://raw.github.com/gist/a7f00c6d46fcdaab5922" type="text/javascript"></script>
  </body>
</html>